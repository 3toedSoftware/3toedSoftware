<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
        />
        <title>Mapping Slayer - Professional Sign Mapping Platform</title>
        <link rel="stylesheet" href="./shared/styles/suite-header.css" />

        <!-- App-specific stylesheets should be loaded dynamically by each app, not globally -->

        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/classic.min.css"
        />

        <!-- External libraries -->
        <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

        <!-- Tabulator removed - not needed for standalone -->
    </head>
    <body>
        <div id="app-container"></div>

        <script type="module">
            /**
             * Dynamically loads a script and returns a promise
             */
            function loadScript(url) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = url;
                    script.onload = () => resolve();
                    script.onerror = () => reject(new Error(`Failed to load script: ${url}`));
                    document.head.appendChild(script);
                });
            }

            /**
             * Creates the main suite structure with permanent header
             */
            function createSuiteStructure() {
                return `
                <div class="slayer-app-container">
                    <!-- Unified Header (always visible) -->
                    <div class="slayer-header">
                        <!-- User Menu -->
                        <div class="user-menu">
                            <div class="user-icon">3T</div>
                            <div class="user-flyout">
                                <div class="flyout-item">üë§ Profile Settings</div>
                                <div class="flyout-item">‚öôÔ∏è Preferences</div>
                                <div class="flyout-item">üìä Usage Stats</div>
                                <div class="flyout-item">‚ùì Help & Support</div>
                                <div class="flyout-item">üìÑ Documentation</div>
                                <div class="flyout-item danger">üö™ Sign Out</div>
                            </div>
                        </div>

                        <!-- Logo Section -->
                        <div class="logo-section">
                            <img src="./apps/mapping_slayer/MSLogo.svg" alt="Mapping Slayer" class="suite-logo" style="height: 40px; width: auto;" onerror="this.style.display='none'; document.getElementById('logo-text').style.display='inline';">
                            <span id="logo-text" style="display: none;" class="suite-logo">MAPPING SLAYER</span>
                        </div>

                        <!-- App Navigation -->
                        <div class="app-navigation">
                            <!-- App buttons removed - single app mode -->
                        </div>

                        <!-- Project Info -->
                        <div class="project-info">
                            <div class="project-name" id="project-name-display">No project loaded</div>
                            <div class="autosave-container">
                                <input type="checkbox" id="autosave-checkbox">
                                <label for="autosave-checkbox">Autosave (5min)</label>
                            </div>
                        </div>

                        <!-- Header Controls -->
                        <div class="header-controls">
                            <button type="button" class="btn btn-secondary" id="load-project-btn">LOAD</button>
                            <button type="button" class="btn btn-primary" id="save-project-btn">SAVE</button>
                            <button type="button" class="btn btn-primary" id="save-as-project-btn">SAVE AS</button>
                        </div>
                    </div>

                    <!-- Content Area (changes based on active app) -->
                    <div class="app-content" id="app-content"></div>
                </div>
            `;
            }

            /**
             * Main Slayer Suite initializer
             */
            async function initializeSlayerSuite() {
                try {
                    // Load debug configuration first
                    await loadScript('./core/debug-config.js');

                    // Load PDF.js for Mapping Slayer
                    if (window.debugLog) {
                        window.debugLog('VERBOSE', 'Loading PDF.js library...');
                    }
                    try {
                        await loadScript(
                            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js'
                        );
                        if (window.pdfjsLib) {
                            pdfjsLib.GlobalWorkerOptions.workerSrc =
                                'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                            if (window.debugLog) {
                                window.debugLog('VERBOSE', 'PDF.js configured successfully.');
                            }
                        }
                    } catch (pdfError) {
                        console.warn(
                            'PDF.js failed to load, continuing without PDF support:',
                            pdfError
                        );
                    }

                    // Import core framework
                    const { initializeCore, appBridge, saveManager } = await import(
                        './core/index.js'
                    );

                    // Import all app modules
                    const MappingSlayerApp = (await import('./apps/mapping_slayer/mapping-app.js'))
                        .default;
                    const DesignSlayerApp = (await import('./apps/design_slayer/design-app.js'))
                        .default;
                    // Thumbnail Slayer not included in standalone version

                    // Initialize core
                    initializeCore(true);

                    // Expose appBridge to window for cross-app communication
                    window.appBridge = appBridge;

                    // Get main container and create suite structure
                    const mainContainer = document.getElementById('app-container');
                    mainContainer.innerHTML = createSuiteStructure();

                    // Get the content area where apps will render
                    const contentArea = document.getElementById('app-content');

                    // Initialize all apps
                    const apps = {
                        mapping_slayer: new MappingSlayerApp(),
                        design_slayer: new DesignSlayerApp()
                    };

                    // Initialize all apps with their own containers in suite mode
                    for (const [name, app] of Object.entries(apps)) {
                        // Create a container for each app
                        const appContainer = document.createElement('div');
                        appContainer.id = `${name}-container`;
                        appContainer.style.display = 'none';
                        appContainer.style.width = '100%';
                        appContainer.style.height = '100%';
                        contentArea.appendChild(appContainer);

                        await app.initialize(appContainer, true);
                    }

                    // Initialize the save manager
                    await saveManager.initialize();

                    // Make saveManager globally available for apps
                    window.saveManager = saveManager;
                    if (window.debugLog) {
                        window.debugLog('VERBOSE', 'üìä [Main] SaveManager made globally available');
                    }

                    // Just load Mapping Slayer directly - no app switching needed
                    await appBridge.switchToApp('mapping_slayer');

                    // Hide breadcrumb since we're not switching apps (check if elements exist first)
                    const breadcrumbSep = document.getElementById('breadcrumb-sep');
                    const appNameDisplay = document.getElementById('app-name-display');
                    if (breadcrumbSep) breadcrumbSep.style.display = 'none';
                    if (appNameDisplay) appNameDisplay.style.display = 'none';

                    if (window.logAlways) {
                        window.logAlways('Mapping Slayer initialized successfully!');
                        window.logAlways('Ready to map!');
                    }
                } catch (error) {
                    console.error('Failed to initialize Mapping Slayer:', error);
                    const container = document.getElementById('app-container');
                    container.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #ff6b6b;">
                        <h2>Initialization Error</h2>
                        <p>Failed to load Mapping Slayer. Please check the console for details.</p>
                        <p>${error.message}</p>
                    </div>
                `;
                }
            }

            // Start the suite
            initializeSlayerSuite();
        </script>
    </body>
</html>
