<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Auto-Sync Test for Mapping Slayer</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
            }
            .test-section {
                margin: 20px 0;
                padding: 15px;
                border: 1px solid #ccc;
                border-radius: 5px;
            }
            .test-passed {
                background-color: #d4edda;
                border-color: #c3e6cb;
            }
            .test-failed {
                background-color: #f8d7da;
                border-color: #f5c6cb;
            }
            .console-output {
                background-color: #f8f9fa;
                padding: 10px;
                border-radius: 3px;
                font-family: monospace;
                max-height: 200px;
                overflow-y: auto;
            }
            button {
                padding: 8px 16px;
                margin: 5px;
                cursor: pointer;
            }
        </style>
    </head>
    <body>
        <h1>Auto-Sync Test for Mapping Slayer</h1>

        <div class="test-section">
            <h3>Test Setup</h3>
            <p>
                This test verifies that marker type changes automatically trigger sync operations in
                Mapping Slayer.
            </p>
            <button onclick="runTests()">Run Auto-Sync Tests</button>
            <button onclick="clearOutput()">Clear Output</button>
        </div>

        <div class="test-section">
            <h3>Test Results</h3>
            <div id="test-results"></div>
        </div>

        <div class="test-section">
            <h3>Console Output</h3>
            <div id="console-output" class="console-output"></div>
        </div>

        <script type="module">
            // Import the state system
            import {
                appState,
                initializeSyncAdapter,
                enableAutoSync,
                withoutAutoSync,
                triggerManualSync
            } from './apps/mapping_slayer/state.js';

            let testResults = [];
            let originalConsoleLog = console.log;
            let consoleOutput = [];

            // Override console.log to capture output
            console.log = function (...args) {
                const message = args.join(' ');
                consoleOutput.push(message);
                updateConsoleOutput();
                originalConsoleLog.apply(console, args);
            };

            function updateConsoleOutput() {
                const outputDiv = document.getElementById('console-output');
                outputDiv.innerHTML = consoleOutput.map(msg => `<div>${msg}</div>`).join('');
                outputDiv.scrollTop = outputDiv.scrollHeight;
            }

            function clearOutput() {
                consoleOutput = [];
                testResults = [];
                updateConsoleOutput();
                document.getElementById('test-results').innerHTML = '';
            }

            function addTestResult(testName, passed, message) {
                testResults.push({ testName, passed, message });
                updateTestResults();
            }

            function updateTestResults() {
                const resultsDiv = document.getElementById('test-results');
                resultsDiv.innerHTML = testResults
                    .map(
                        result =>
                            `<div class="${result.passed ? 'test-passed' : 'test-failed'}" style="margin: 5px 0; padding: 10px;">
                    <strong>${result.testName}</strong>: ${result.passed ? '‚úÖ PASSED' : '‚ùå FAILED'}<br>
                    ${result.message}
                </div>`
                    )
                    .join('');
            }

            // Mock sync adapter for testing
            class MockSyncAdapter {
                constructor() {
                    this.syncCalls = [];
                }

                async syncMarkerTypes(appBridge) {
                    this.syncCalls.push({
                        timestamp: new Date().toISOString(),
                        markerTypesCount: Object.keys(appState.markerTypes).length
                    });
                    console.log(
                        'üîÑ Mock sync called with',
                        Object.keys(appState.markerTypes).length,
                        'marker types'
                    );
                    return Promise.resolve();
                }

                getSyncCalls() {
                    return this.syncCalls;
                }

                clearSyncCalls() {
                    this.syncCalls = [];
                }
            }

            let mockSyncAdapter;

            async function runTests() {
                console.log('üß™ Starting Auto-Sync Tests...');
                clearOutput();

                try {
                    // Test 1: Initialize auto-sync system
                    console.log('Test 1: Initializing auto-sync system...');
                    mockSyncAdapter = new MockSyncAdapter();
                    initializeSyncAdapter(mockSyncAdapter);
                    enableAutoSync();

                    // Give time for proxy to be set up
                    await new Promise(resolve => setTimeout(resolve, 200));

                    addTestResult(
                        'Initialize Auto-Sync',
                        true,
                        'Auto-sync system initialized successfully'
                    );

                    // Test 2: Test individual marker type assignment
                    console.log('Test 2: Testing individual marker type assignment...');
                    mockSyncAdapter.clearSyncCalls();

                    appState.markerTypes['TEST.1'] = {
                        code: 'TEST.1',
                        name: 'Test Marker Type 1',
                        color: '#FF0000',
                        textColor: '#FFFFFF'
                    };

                    // Wait for debounced sync
                    await new Promise(resolve => setTimeout(resolve, 150));

                    const syncCalls1 = mockSyncAdapter.getSyncCalls();
                    const test2Passed = syncCalls1.length === 1;
                    addTestResult(
                        'Individual Assignment Sync',
                        test2Passed,
                        test2Passed
                            ? 'Sync triggered correctly for individual assignment'
                            : `Expected 1 sync call, got ${syncCalls1.length}`
                    );

                    // Test 3: Test rapid multiple changes (debouncing)
                    console.log('Test 3: Testing rapid multiple changes (debouncing)...');
                    mockSyncAdapter.clearSyncCalls();

                    appState.markerTypes['TEST.2'] = {
                        code: 'TEST.2',
                        name: 'Test 2',
                        color: '#00FF00',
                        textColor: '#000000'
                    };
                    appState.markerTypes['TEST.3'] = {
                        code: 'TEST.3',
                        name: 'Test 3',
                        color: '#0000FF',
                        textColor: '#FFFFFF'
                    };
                    appState.markerTypes['TEST.4'] = {
                        code: 'TEST.4',
                        name: 'Test 4',
                        color: '#FFFF00',
                        textColor: '#000000'
                    };

                    // Wait for debounced sync
                    await new Promise(resolve => setTimeout(resolve, 150));

                    const syncCalls3 = mockSyncAdapter.getSyncCalls();
                    const test3Passed = syncCalls3.length === 1; // Should be debounced to 1 call
                    addTestResult(
                        'Debouncing Test',
                        test3Passed,
                        test3Passed
                            ? 'Multiple rapid changes correctly debounced to single sync call'
                            : `Expected 1 sync call, got ${syncCalls3.length}`
                    );

                    // Test 4: Test deletion
                    console.log('Test 4: Testing marker type deletion...');
                    mockSyncAdapter.clearSyncCalls();

                    delete appState.markerTypes['TEST.1'];

                    // Wait for debounced sync
                    await new Promise(resolve => setTimeout(resolve, 150));

                    const syncCalls4 = mockSyncAdapter.getSyncCalls();
                    const test4Passed = syncCalls4.length === 1;
                    addTestResult(
                        'Deletion Sync',
                        test4Passed,
                        test4Passed
                            ? 'Sync triggered correctly for deletion'
                            : `Expected 1 sync call, got ${syncCalls4.length}`
                    );

                    // Test 5: Test withoutAutoSync prevents sync
                    console.log('Test 5: Testing withoutAutoSync prevents sync...');
                    mockSyncAdapter.clearSyncCalls();

                    withoutAutoSync(() => {
                        appState.markerTypes['TEST.5'] = {
                            code: 'TEST.5',
                            name: 'Test 5',
                            color: '#FF00FF',
                            textColor: '#FFFFFF'
                        };
                        appState.markerTypes['TEST.6'] = {
                            code: 'TEST.6',
                            name: 'Test 6',
                            color: '#00FFFF',
                            textColor: '#000000'
                        };
                    });

                    // Wait to ensure no sync happens
                    await new Promise(resolve => setTimeout(resolve, 150));

                    const syncCalls5 = mockSyncAdapter.getSyncCalls();
                    const test5Passed = syncCalls5.length === 0;
                    addTestResult(
                        'withoutAutoSync Test',
                        test5Passed,
                        test5Passed
                            ? 'withoutAutoSync correctly prevented sync calls'
                            : `Expected 0 sync calls, got ${syncCalls5.length}`
                    );

                    // Test 6: Test manual sync trigger
                    console.log('Test 6: Testing manual sync trigger...');
                    mockSyncAdapter.clearSyncCalls();

                    triggerManualSync();

                    // Wait for debounced sync
                    await new Promise(resolve => setTimeout(resolve, 150));

                    const syncCalls6 = mockSyncAdapter.getSyncCalls();
                    const test6Passed = syncCalls6.length === 1;
                    addTestResult(
                        'Manual Sync Trigger',
                        test6Passed,
                        test6Passed
                            ? 'Manual sync trigger worked correctly'
                            : `Expected 1 sync call, got ${syncCalls6.length}`
                    );

                    console.log('‚úÖ All auto-sync tests completed!');

                    const passedTests = testResults.filter(r => r.passed).length;
                    const totalTests = testResults.length;
                    console.log(`üìä Test Summary: ${passedTests}/${totalTests} tests passed`);
                } catch (error) {
                    console.error('‚ùå Test error:', error);
                    addTestResult(
                        'Test Execution',
                        false,
                        `Error during test execution: ${error.message}`
                    );
                }
            }

            // Make runTests available globally
            window.runTests = runTests;
            window.clearOutput = clearOutput;

            console.log('üîß Auto-sync test page loaded and ready');
        </script>
    </body>
</html>
