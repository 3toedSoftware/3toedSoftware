<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Test DOT Column Colors</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                padding: 20px;
                background: #1a1a1a;
                color: #fff;
            }
            .test-section {
                margin: 20px 0;
                padding: 20px;
                border: 1px solid #444;
                border-radius: 5px;
                background: #2a2a2a;
            }
            h2 {
                color: #f07727;
                margin-top: 0;
            }
            .status {
                padding: 10px;
                margin: 10px 0;
                border-radius: 3px;
            }
            .success {
                background: #2d5a2d;
                color: #90ee90;
            }
            .error {
                background: #5a2d2d;
                color: #ff6b6b;
            }
            .info {
                background: #2d3a5a;
                color: #6bb6ff;
            }
            button {
                background: #f07727;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 3px;
                cursor: pointer;
                margin: 5px;
            }
            button:hover {
                background: #d85e15;
            }
            .dot-preview {
                display: inline-block;
                width: 20px;
                height: 20px;
                border-radius: 50%;
                margin: 0 10px;
                vertical-align: middle;
                border: 1px solid rgba(255, 255, 255, 0.3);
            }
            table {
                width: 100%;
                border-collapse: collapse;
                margin: 10px 0;
            }
            th,
            td {
                border: 1px solid #444;
                padding: 8px;
                text-align: left;
            }
            th {
                background: #333;
            }
        </style>
    </head>
    <body>
        <h1>DOT Column Color Synchronization Test</h1>

        <div class="test-section">
            <h2>Test Setup</h2>
            <p>
                This test verifies that the DOT column in Thumbnail Slayer matches the marker colors
                from Mapping Slayer.
            </p>
            <button onclick="runTest()">Run Test</button>
            <button onclick="openSlayerSuite()">Open Slayer Suite</button>
        </div>

        <div class="test-section">
            <h2>Marker Types from Mapping Slayer</h2>
            <div id="marker-types"></div>
        </div>

        <div class="test-section">
            <h2>DOT Column Colors in Thumbnail Slayer</h2>
            <div id="dot-colors"></div>
        </div>

        <div class="test-section">
            <h2>Test Results</h2>
            <div id="test-results"></div>
        </div>

        <script type="module">
            window.runTest = async function () {
                const resultsDiv = document.getElementById('test-results');
                resultsDiv.innerHTML = '<div class="status info">Running test...</div>';

                try {
                    // Open Slayer Suite in iframe to test
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = 'http://localhost:8080';
                    document.body.appendChild(iframe);

                    // Wait for iframe to load
                    await new Promise(resolve => {
                        iframe.onload = resolve;
                        setTimeout(resolve, 3000); // Timeout after 3 seconds
                    });

                    // Access the iframe's window
                    const iframeWindow = iframe.contentWindow;

                    // Check if appBridge is available
                    if (!iframeWindow.appBridge) {
                        throw new Error('AppBridge not found - make sure Slayer Suite is loaded');
                    }

                    // Get marker types from Mapping Slayer
                    const mappingResponse = await iframeWindow.appBridge.sendRequest(
                        'mapping_slayer',
                        {
                            type: 'get-marker-types'
                        }
                    );

                    const markerTypes = mappingResponse?.markerTypes || {};

                    // Display marker types
                    const markerTypesDiv = document.getElementById('marker-types');
                    if (Object.keys(markerTypes).length > 0) {
                        let html =
                            '<table><tr><th>Marker Type</th><th>Name</th><th>Color</th><th>Preview</th></tr>';
                        for (const [code, info] of Object.entries(markerTypes)) {
                            html += `<tr>
                            <td>${code}</td>
                            <td>${info.name}</td>
                            <td>${info.color}</td>
                            <td><span class="dot-preview" style="background-color: ${info.color}"></span></td>
                        </tr>`;
                        }
                        html += '</table>';
                        markerTypesDiv.innerHTML = html;
                    } else {
                        markerTypesDiv.innerHTML =
                            '<div class="status info">No marker types found in Mapping Slayer</div>';
                    }

                    // Get locations to check DOT colors
                    const locationsResponse = await iframeWindow.appBridge.sendRequest(
                        'mapping_slayer',
                        {
                            type: 'get-all-locations'
                        }
                    );

                    // Check if Thumbnail Slayer has the marker types
                    const thumbnailWindow = iframeWindow;
                    const thumbnailState = thumbnailWindow.thumbnailState;

                    if (thumbnailState) {
                        const dotColorsDiv = document.getElementById('dot-colors');

                        if (
                            thumbnailState.markerTypes &&
                            Object.keys(thumbnailState.markerTypes).length > 0
                        ) {
                            let html =
                                '<table><tr><th>Marker Type</th><th>Expected Color</th><th>Actual Color</th><th>Match</th></tr>';

                            for (const [code, mappingInfo] of Object.entries(markerTypes)) {
                                const thumbnailColor =
                                    thumbnailState.markerTypes[code]?.color || 'Not found';
                                const match = thumbnailColor === mappingInfo.color;

                                html += `<tr>
                                <td>${code}</td>
                                <td>${mappingInfo.color} <span class="dot-preview" style="background-color: ${mappingInfo.color}"></span></td>
                                <td>${thumbnailColor} ${thumbnailColor !== 'Not found' ? `<span class="dot-preview" style="background-color: ${thumbnailColor}"></span>` : ''}</td>
                                <td>${match ? '✓' : '✗'}</td>
                            </tr>`;
                            }
                            html += '</table>';
                            dotColorsDiv.innerHTML = html;

                            // Check if all colors match
                            const allMatch = Object.keys(markerTypes).every(
                                code =>
                                    thumbnailState.markerTypes[code]?.color ===
                                    markerTypes[code].color
                            );

                            if (allMatch) {
                                resultsDiv.innerHTML =
                                    '<div class="status success">✓ All DOT colors match Mapping Slayer marker colors!</div>';
                            } else {
                                resultsDiv.innerHTML =
                                    '<div class="status error">✗ Some DOT colors do not match Mapping Slayer marker colors</div>';
                            }
                        } else {
                            dotColorsDiv.innerHTML =
                                '<div class="status error">Marker types not synced to Thumbnail Slayer</div>';
                            resultsDiv.innerHTML =
                                '<div class="status error">✗ Marker types data not found in Thumbnail Slayer state</div>';
                        }
                    } else {
                        resultsDiv.innerHTML =
                            '<div class="status error">✗ Could not access Thumbnail Slayer state</div>';
                    }

                    // Clean up iframe
                    document.body.removeChild(iframe);
                } catch (error) {
                    resultsDiv.innerHTML = `<div class="status error">✗ Test failed: ${error.message}</div>`;
                }
            };

            window.openSlayerSuite = function () {
                window.open('http://localhost:8080', '_blank');
            };
        </script>
    </body>
</html>
